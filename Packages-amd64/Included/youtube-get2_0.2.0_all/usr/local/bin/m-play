#!/bin/bash

if [ -z `which yad` ]; then
	msg="  You don't have yad installed.\nIt's a dependency of this program.\n Please install it."
	xmessage "`echo -e $msg`"
exit 0
fi

if [ -z `which wget` ]; then
	msg="  You don't have wget installed.\nIt's a dependency of this program.\n Please install it."
	xmessage "`echo -e $msg`"
exit 0
fi

if [[ -z `which mplayer` && -z `which mpv` ]]; then
	msg="  You don't have mplayer or mpv installed.\nIt's a dependency of this program.\n Please install it."
	xmessage "`echo -e $msg`"
exit 0
fi

# YAD gui
choice=$(yad --title "Play with mplayer" --text "  <b>*** Play a video file or YouTube url with mplayer or mpv ***</b> \n  Browse for a video file to play, or:\n  Enter a YouTube url, for example:\n  http://www.youtube.com/watch?v=OuSdU8tbcHY  " --width 500 --form \
--field=" :SFL" "" \
--field=" Restrict to 360p quality (Youtube) (unchecked=highest available):CHK" "TRUE")
[[ $ret -ne 0 ]] && exit
url="`echo $choice | cut -d "|" -f 1`"
RESTR="`echo $choice | cut -d "|" -f 2`"

if [ `which mpv` ]; then
player=mpv
else
player=mplayer
fi

itag () {
#    export v=$(grep -i "itag%3D${1}%" $code 2> /dev/null)
export v=$(grep -i "itag%3D${1}%\|itag%3D${1}$" "$code" 2> /dev/null)
    if [ -z "$v" ];then
        echo -e "Not Found Itag:${Y}$1${D} Quality:${Y}$2${D}"          
    else
        echo -e "Found: Itag:${Y}$1${D} Quality:${Y}$2${D}"

#        export l=$(percentdecode.pl "$v")
        export l=$(urldecode "$v")
            export link="$l"

        $player "$link"

        rm -f $code
	exit
    fi
}
export -f itag

urldecode() {
ENC_STR=$@
[ "${ENC_STR}x" == "x" ] && {
TMP_STR="$(cat - | sed -e 's/%/\\x/g')"
} || {
TMP_STR="$(echo ${ENC_STR} | sed -e 's/%/\\x/g')"
}
PRINTF=/usr/bin/printf
exec ${PRINTF} "${TMP_STR}\n"
}
export -f urldecode

if_url() {
export code=`tempfile 2>/dev/null` || code=/tmp/test$$
export u="$url"
echo -e "Found URL $u"
echo
echo -e "Downloading the code"

wget --no-check-certificate -q -O - "$u" > "$code"
echo -e "Done"
echo -e "Parsing"
( tr '"' '\n' < $code ) > ${code}.tr
sed -i -r 's/\\u0026/\n/g' ${code}.tr
sed -i -r 's/,/\n/g' ${code}.tr
grep -i "url" ${code}.tr | grep -i "googlevideo.com" > "$code"
sed -i -r 's/url=//g' "$code"
export TITLE=$(grep '<title>' $code.tr | sed -e 's#.*<title>##' -e 's# - YouTube</title>.*##' | sed 's/ /_/g')
rm -f ${code}.tr

if [ "$RESTR" = "TRUE" ]; then
    itag 18 360p
    itag 34 360p
    itag 5  240p
    itag 17 144p
else
    itag 22 720p
    itag 45 720p
    itag 44 480p
    itag 35 480p
    itag 43 360p
    itag 18 360p
    itag 34 360p
    itag 5  240p
    itag 17 144p
fi
}

CHECKURL=$(echo "$url" | grep "http://\|https://" 2> /dev/null)
if [ -n "$CHECKURL" ]; then
if_url
else
$player "$url"
fi
exit 0 





